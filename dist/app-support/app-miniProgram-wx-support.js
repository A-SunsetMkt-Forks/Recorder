/*
录音
https://github.com/xiangyuecn/Recorder
src: app-support/app-miniProgram-wx-support.js
*/
!function(e){var n="object"==typeof window&&!!window.document,r=(n?window:Object).Recorder,t=r.i18n;!function(a,e,n,r){"use strict";var t="object"==typeof wx&&!!wx.getRecorderManager,f=a.RecordApp,_=f.CLog,i={Support:function(e){e(t)},CanProcess:function(){return!0}};f.RegisterPlatform("miniProgram-wx",i),f.MiniProgramWx_onShow=function(){v()},i.RequestPermission=function(e,n,r){o(n,r)},i.Start=function(e,n,r,t){x.param=n;var o=a(n);o.set.disableEnvInFix=!0,o.dataType="arraybuffer",x.rec=o,f.__Rec=o,m(r,t)},i.Stop=function(n,t,r){l();var o=function(e){f.__Sync(n)&&(x.rec=null),r(e)},a=x.rec;x.rec=null;var e=t?"":f.__StopOnlyClearMsg();if(a){_("rec encode: pcm:"+a.recSize+" srcSR:"+a.srcSampleRate+" set:"+JSON.stringify(x.param));var i=function(){if(f.__Sync(n))for(var e in a.set)x.param[e]=a.set[e]};if(!t)return i(),void o(e);a.stop(function(e,n,r){i(),t(e,n,r)},function(e){i(),o(e)})}else o("未开始录音"+(e?" ("+e+")":""))};var s,c,M,R,x=function(e,n){var r=x.rec;if(r){r._appStart||r.envStart({envName:i.Key,canProcess:i.CanProcess()},n),r._appStart=1;for(var t=0,o=0;o<e.length;o++)t+=Math.abs(e[o]);r.envIn(e,t)}else _("未开始录音，但收到wx PCM数据",3)},u=!1,o=function(e,r){if(l(),u)e();else{var t=wx.getRecorderManager(),o=1;t.onStart(function(){u=!0,o&&(o=0,t.stop(),e())}),t.onError(function(e){var n="请求录音权限出现错误："+e.errMsg;_(n+"。"+g,1,e),o&&(o=0,t.stop(),r(n,!0))}),p(t)}},g="请自行检查wx.getSetting中的scope.record录音权限，如果用户拒绝了权限，请引导用户到小程序设置中授予录音权限。",l=function(){var e=s;s=null,e&&e.stop()},p=function(e){e.start({duration:6e5,sampleRate:48e3,encodeBitRate:32e4,numberOfChannels:1,format:"PCM",frameSize:c?1:4})},v=function(){s&&s.__pause&&(_("mg onShow 录音开始恢复...",3),s.resume())},m=function(n,r){if(l(),null==c){var e=wx.getSystemInfoSync();(c="devtools"==e.platform?1:0)&&(M=wx.createWebAudioContext())}R={},c&&_("RecorderManager.onFrameRecorded 在开发工具中测试返回的是webm格式音频，将会尝试进行解码",3);var t=!1,o=function(e){t||(t=!0,e?(l(),r(e)):n())},a=s=wx.getRecorderManager();a.onInterruptionEnd(function(){a==s&&(_("mg onInterruptionEnd 录音开始恢复...",3),a.resume())}),a.onPause(function(){a==s&&(a.__pause=Date.now(),_("mg onPause 录音被打断",3))}),a.onResume(function(){if(a==s){var e=a.__pause?Date.now()-a.__pause:0,n=0;a.__pause=0,300<e&&(n=Math.min(1e3,e),x(new Int16Array(48*n),48e3)),_("mg onResume 恢复录音，填充了"+n+"ms静默",3)}}),a.onError(function(e){a==s&&(_("mg onError 开始录音出错："+e.errMsg+"。"+g,1,e),o("开始录音出错："+e.errMsg))}),a.onStart(function(){a==s&&(_("mg onStart 已开始录音"),o())}),a.onStop(function(e){_("mg onStop res:",e),a==s&&(_("mg onStop 已停止录音，正在重新开始录音..."),p(a))}),a.onFrameRecorded(function(e){if(a==s){t||_("mg onStart未触发，但收到了onFrameRecorded",3),o();var n=e.frameBuffer;n.byteLength&&(c?h(new Uint8Array(n)):x(new Int16Array(n),48e3))}}),p(a)},h=function(e){var n=R;n.pos||(n.pos=[0],n.tracks={},n.bytes=[]);var r=n.tracks,t=[n.pos[0]],o=function(){n.pos[0]=t[0]},a=n.bytes.length,i=new Uint8Array(a+e.length);i.set(n.bytes),i.set(e,a),n.bytes=i;var f=function(){n.bytes=[],x(new Int16Array(i),48e3)};if(n.isNotWebM)f();else{if(!n._ht){for(var s=0,c=0;c<i.length;c++)if(26==i[c]&&69==i[c+1]&&223==i[c+2]&&163==i[c+3]){s=c,t[0]=c+4;break}if(!t[0])return void(5120<i.length&&(_("未识别到WebM数据，开发工具可能已支持PCM",3),n.isNotWebM=!0,f()));if(I(i,t),!P(A(i,t),[24,83,128,103]))return;for(A(i,t);t[0]<i.length;){var u=A(i,t),g=I(i,t);if(!g)return;if(P(u,[22,84,174,107])){n._ht=i.slice(s,t[0]),_("WebM Tracks",r),o();break}}}for(var l=[],p=0;t[0]<i.length;){var v=t[0],m=A(i,t),h=(t[0],I(i,t));if(!h)break;if(P(m,[163])){var d=i.slice(v,t[0]);p+=d.length,l.push(d)}o()}if(p){var w=new Uint8Array(i.length-n.pos[0]);w.set(i.subarray(n.pos[0])),n.bytes=w,n.pos[0]=0;var S=[31,67,182,117,1,255,255,255,255,255,255,255];S.push(231,129,0),p+=S.length,l.splice(0,0,S),p+=n._ht.length,l.splice(0,0,n._ht);for(var b=new Uint8Array(p),c=0,y=0;c<l.length;c++)b.set(l[c],y),y+=l[c].length;M.decodeAudioData(b.buffer,function(e){for(var n=e.getChannelData(0),r=new Int16Array(n.length),t=0;t<n.length;t++){var o=Math.max(-1,Math.min(1,n[t]));o=o<0?32768*o:32767*o,r[t]=o}x(r,e.sampleRate)},function(){_("WebM解码失败",1)})}}},P=function(e,n){if(!e||e.length!=n.length)return!1;if(1==e.length)return e[0]==n[0];for(var r=0;r<e.length;r++)if(e[r]!=n[r])return!1;return!0},A=function(e,n,r){var t=n[0];if(!(t>=e.length)){var o=e[t],a=("0000000"+o.toString(2)).substr(-8),i=/^(0*1)(\d*)$/.exec(a);if(i){var f=i[1].length,s=[];if(!(t+f>e.length)){for(var c=0;c<f;c++)s[c]=e[t],t++;return r&&(s[0]=parseInt(i[2]||"0",2)),n[0]=t,s}}}},I=function(e,n){var r=A(e,n,1);if(r){var t=function(e){for(var n="",r=0;r<e.length;r++){var t=e[r];n+=(t<16?"0":"")+t.toString(16)}return parseInt(n,16)||0}(r),o=n[0],a=[];if(t<2147483647){if(o+t>e.length)return;for(var i=0;i<t;i++)a[i]=e[o],o++}return n[0]=o,a}}}(r,0,t.$T)}();
/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/buffer_stream.player.js
*/
!function(){"use strict";var a=function(e){return new t(e)},t=function(e){var t={play:!0,realtime:!0};for(var r in e)t[r]=e[r];this.set=e=t,e.onInputError||(e.onInputError=function(e,t){console.error("[BufferStreamPlayer]"+e)})};t.prototype=a.prototype={getAudioSrc:function(){return this._src||(this._src=(window.URL||webkitURL).createObjectURL(this.getMediaStream())),this._src},getMediaStream:function(){if(!this._dest)throw new Error("BufferStreamPlayer未start");return this._dest.stream},start:function(t,e){var r=this;r.inputN=0,r.inputQueueIdx=0,r.inputQueue=[],r.bufferSampleRate=0,r.audioBuffer=0,r.pcmBuffer=[[],[]];var n=1;if(Recorder.Support()){var a=Recorder.Ctx.createBufferSource();a.start&&void 0!==a.onended||(n=0)}else n=0;n?(setTimeout(function(){var e=Recorder.Ctx.createMediaStreamDestination();e.channelCount=1,r._dest=e,t&&t(),r._inputProcess()}),r._writeInt=setInterval(function(){r.audioBuffer&&r._writeBuffer()},500)):e&&e("浏览器不支持打开BufferStreamPlayer")},stop:function(){var e=this;clearInterval(e._writeInt),e._src&&((window.URL||webkitURL).revokeObjectURL(e._src),e._src=0);var t=e.bufferSource;t&&(t.disconnect(),t.stop()),e.bufferSource=0,e.audioBuffer=0},input:function(e){var t=this,r=t.set,n=++t.inputN;r.decode?a.DecodeAudio(e,function(e){t._input2(n,e.data,e.sampleRate)},function(e){t._inputErr(e,n)}):t._input2(n,e,r.sampleRate)},_input2:function(r,e,n){var a=this,t=a.set;t.transform?t.transform(e,n,function(e,t){n=t||n,a._input3(r,e,n)},function(e){a._inputErr(e,r)}):a._input3(r,e,n)},_input3:function(e,t,r){var n=this;t&&t.subarray?r?n.bufferSampleRate&&n.bufferSampleRate!=r?n._inputErr("input调用失败：data的sampleRate="+r+"和之前的="+n.bufferSampleRate+"不同",e):(n.bufferSampleRate||(n.bufferSampleRate=r),n.inputQueue[e]=t,n._dest&&n._inputProcess()):n._inputErr("input调用失败：未提供sampleRate",e):n._inputErr("input调用失败：非pcm[Int16,...]输入时，必须解码或者使用transform转换",e)},_inputErr:function(e,t){this.inputQueue[t]=1,this.set.onInputError(e,t)},_inputProcess:function(){var e=this;if(e.bufferSampleRate){for(var t=e.inputQueue,r=e.inputQueueIdx+1;r<t.length;r++){var n=t[r];if(1!=n){if(!n)return;t[e.inputQueueIdx=r]=null;var a=e.pcmBuffer,u=a[0],f=a[1];if(u.length){if(f.length){var i=new Int16Array(u.length+f.length);i.set(u),i.set(f,u.length),a[0]=i}}else a[0]=f;a[1]=n}else e.inputQueueIdx=r}e.audioBuffer?e._writeBuffer():e._createBuffer(!0)}},_createBuffer:function(e){var t=this,r=t.set;if(e||t.audioBuffer){var n=Recorder.Ctx,a=t.bufferSampleRate,u=60*a,f=n.createBuffer(1,u,a),i=n.createBufferSource();i.channelCount=1,i.buffer=f,i.connect(t._dest),r.play&&i.connect(n.destination),i.onended=function(){i.disconnect(),i.stop(),t._createBuffer()},i.start(),t.bufferSource=i,t.audioBuffer=f,t.audioBufferIdx=0,t._createBufferTime=Date.now(),t._writeBuffer()}},_writeBuffer:function(){var e=this,t=e.set,r=e.audioBuffer,n=e.bufferSampleRate,a=e.audioBufferIdx,u=Math.floor((Date.now()-e._createBufferTime)/1e3*n);e.audioBufferIdx+.005*n<u&&(e.audioBufferIdx=u);var f=Math.max(0,e.audioBufferIdx-u),i=r.length-e.audioBufferIdx;if(!((i=Math.min(i,~~(.8*n)-f))<1)){var o=e.pcmBuffer,c=o[0],s=o[1];if(c.length+s.length!=0){for(var d=0,p=1,l=t.realtime;l;){var h=f+c.length;if(h<.3*n){var m=Math.floor(.15*n-h);0==a&&0<m&&(e.audioBufferIdx=Math.max(e.audioBufferIdx,m)),l=!1;break}var _=3*n-f;c.length>_&&(c=c.subarray(c.length-_),o[0]=c),p=1.6,d=Math.min(i,Math.floor((c.length+s.length)/p));break}if(l||(d=Math.min(i,c.length+s.length)),d){for(var B=new Int16Array(d),v=0,g=0,R=0;g<d&&R<c.length;)B[g++]=c[v],R+=p,v=Math.round(R);if(v>=c.length){for(c=new Int16Array(0),v=R=0;g<d&&R<s.length;)B[g++]=s[v],R+=p,v=Math.round(R);s=v>=s.length?new Int16Array(0):s.subarray(v),o[1]=s}else c=c.subarray(v);o[0]=c;var I=r.getChannelData(0);for(v=0,g=e.audioBufferIdx;v<d;v++,g++)I[g]=B[v]/32767;e.audioBufferIdx=g}}}}},a.DecodeAudio=function(e,f,t){Recorder.Support()?Recorder.Ctx.decodeAudioData(e,function(e){for(var t=e.getChannelData(0),r=e.sampleRate,n=new Int16Array(t.length),a=0;a<t.length;a++){var u=Math.max(-1,Math.min(1,t[a]));u=u<0?32768*u:32767*u,n[a]=u}f&&f({sampleRate:r,duration:Math.round(t.length/r*1e3),data:n})},function(e){t&&t("音频解码失败:"+(e&&e.message||"-"))}):t&&t("浏览器不支持音频解码")},Recorder.BufferStreamPlayer=a}();
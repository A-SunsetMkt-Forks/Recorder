/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/buffer_stream.player.js
*/
!function(){"use strict";var l=function(e){return new t(e)},p="BufferStreamPlayer",t=function(e){var t={play:!0,realtime:!0};for(var r in e)t[r]=e[r];this.set=e=t,e.onInputError||(e.onInputError=function(e,t){console.error("["+p+"]"+e)})};t.prototype=l.prototype={getAudioSrc:function(){return console.warn("getAudioSrc方法已过时：请直接使用getMediaStream然后赋值给audio.srcObject，仅允许在不支持srcObject的浏览器中调用本方法赋值给audio.src以做兼容"),this._src||(this._src=(window.URL||webkitURL).createObjectURL(this.getMediaStream())),this._src},getMediaStream:function(){if(!this._dest)throw new Error(p+"未start");return this._dest.stream},start:function(t,r){var a=function(e){console.error(e),r&&r(e)},n=this;if(null==n._Tc){n._Tc=0,n._Td=0,n.currentTime=0,n.duration=0,n.isStop=0,n.isPause=0,n.isPlayEnd=0,n.inputN=0,n.inputQueueIdx=0,n.inputQueue=[],n.bufferSampleRate=0,n.audioBuffer=0,n.pcmBuffer=[[],[]];var e=function(e){a("浏览器不支持打开"+p+(e?"："+e:""))},u=1;if(Recorder.Support()){var i=Recorder.Ctx.createBufferSource();i.start&&void 0!==i.onended||(u=0)}else u=0;if(u){var f=function(){if(n.isStop)console.warn(p+"start被stop终止");else{var e=Recorder.Ctx.createMediaStreamDestination();e.channelCount=1,n._dest=e,t&&t(),n._inputProcess(),n._updateTime(),o?(console.warn(p+"：此浏览器的AudioBuffer实现不支持动态特性，采用兼容模式"),n._writeInt=setInterval(function(){n._writeBad()},10)):n._writeInt=setInterval(function(){n._writeBuffer()},100)}},o=l.BadAudioBuffer;if(n.__abTest||null!=o)setTimeout(f);else{var s=l({play:!1,sampleRate:8e3});s.__abTest=1,s.start(function(){var n=Recorder({type:"unknown",sourceStream:s.getMediaStream(),onProcess:function(e){for(var t=e[e.length-1],r=1,a=0;a<t.length;a++)if(0!=t[a]){r=0;break}r&&e.length<5||(n.close(),s.stop(),l.BadAudioBuffer=o=r,f())}});n.open(function(){n.start()},e)},e);for(var c=new Int16Array(8e3),d=0;d<8e3;d++)c[d]=~~(32767*Math.random()*2-32767);s.input(c)}}else e("")}else a(p+"多次start")},stop:function(){var e=this;e.isStop=1,clearInterval(e._writeInt),e.inputQueue=0,e._src&&((window.URL||webkitURL).revokeObjectURL(e._src),e._src=0);var t=e.bufferSource;t&&(t.disconnect(),t.stop()),e.bufferSource=0,e.audioBuffer=0,e._playEnd(1)},pause:function(){this.isPause=1,this._updateTime(1)},resume:function(){this.isPause=0,this._updateTime(1)},_playEnd:function(e){var t=this,r=t._PNs,a=t.set.onPlayEnd;!e&&t.isPause||!e&&t.isPlayEnd||(e||r&&500<Date.now()-r?(t._PNs=0,t.isPlayEnd=1,a&&a(),t._updateTime(1)):r||(t._PNs=Date.now()))},_playLive:function(){this.isPlayEnd=0,this._PNs=0},_updateTime:function(e){var t=this,r=t.bufferSampleRate||9e9,a=t.set.onUpdateTime;t.currentTime=Math.round(t._Tc/r*1e3),t.duration=Math.round(t._Td/r*1e3);var n=""+t.currentTime+t.duration;(e||t._UTs!=n)&&(t._UTs=n,a&&a())},input:function(e){var t=this,r=t.set,a=++t.inputN;if(!t.inputQueue)throw new Error("未调用start方法");r.decode?n(e,function(e){t.inputQueue&&(v(e.data,e.sampleRate),t._input2(a,e.data,e.sampleRate))},function(e){t._inputErr(e,a)}):t._input2(a,e,r.sampleRate)},_input2:function(r,e,a){var n=this,t=n.set;t.transform?t.transform(e,a,function(e,t){n.inputQueue&&(a=t||a,n._input3(r,e,a))},function(e){n._inputErr(e,r)}):n._input3(r,e,a)},_input3:function(e,t,r){var a=this;t&&t.subarray?r?a.bufferSampleRate&&a.bufferSampleRate!=r?a._inputErr("input调用失败：data的sampleRate="+r+"和之前的="+a.bufferSampleRate+"不同",e):(a.bufferSampleRate||(a.bufferSampleRate=r),a.inputQueue[e]=t,a._dest&&a._inputProcess()):a._inputErr("input调用失败：未提供sampleRate",e):a._inputErr("input调用失败：非pcm[Int16,...]输入时，必须解码或者使用transform转换",e)},_inputErr:function(e,t){this.inputQueue[t]=1,this.set.onInputError(e,t)},_inputProcess:function(){var e=this;if(e.bufferSampleRate){for(var t=e.inputQueue,r=e.inputQueueIdx+1;r<t.length;r++){var a=t[r];if(1!=a){if(!a)return;t[e.inputQueueIdx=r]=null;var n=e.pcmBuffer,u=n[0],i=n[1];if(u.length){if(i.length){var f=new Int16Array(u.length+i.length);f.set(u),f.set(i,u.length),n[0]=f}}else n[0]=i;n[1]=a,e._Td+=a.length,e._updateTime(),e._playLive()}else e.inputQueueIdx=r}l.BadAudioBuffer?e._writeBad():e.audioBuffer?e._writeBuffer():e._createBuffer(!0)}},_createBuffer:function(e){var t=this,r=t.set;if(e||t.audioBuffer){var a=Recorder.Ctx,n=t.bufferSampleRate,u=60*n,i=a.createBuffer(1,u,n),f=a.createBufferSource();f.channelCount=1,f.buffer=i,f.connect(t._dest),r.play&&f.connect(a.destination),f.onended=function(){f.disconnect(),f.stop(),t._createBuffer()},f.start(),t.bufferSource=f,t.audioBuffer=i,t.audioBufferIdx=0,t._createBufferTime=Date.now(),t._writeBuffer()}},_writeBuffer:function(){var e=this,t=e.set,r=e.audioBuffer,a=e.bufferSampleRate,n=e.audioBufferIdx;if(r){var u=Math.floor((Date.now()-e._createBufferTime)/1e3*a);e.audioBufferIdx+.005*a<u&&(e.audioBufferIdx=u);var i=Math.max(0,e.audioBufferIdx-u),f=r.length-e.audioBufferIdx;if(!((f=Math.min(f,~~(.8*a)-i))<1||e._subPause())){var o=e.pcmBuffer,s=o[0],c=o[1];if(s.length+c.length!=0){e._playLive();for(var d=0,l=1,p=t.realtime;p;){var h=i+s.length;if(h<.3*a){var _=Math.floor(.15*a-h);0==n&&0<_&&(e.audioBufferIdx=Math.max(e.audioBufferIdx,_)),p=!1;break}var m=3*a-i;s.length>m&&(s=s.subarray(s.length-m),o[0]=s),l=1.6,d=Math.min(f,Math.floor((s.length+c.length)/l));break}p||(d=Math.min(f,s.length+c.length)),d&&(e.audioBufferIdx=e._subWrite(r,d,e.audioBufferIdx,l))}else e._playEnd()}}},_writeBad:function(){var e=this,t=e.set,r=e.audioBuffer,a=e.bufferSampleRate,n=Recorder.Ctx;if(r){var u=r.length/a*1e3;if(Date.now()-e._createBufferTime<u-5)return}var i=~~(.8*a),f=t.PlayBufferDisable?0:a/1e3*300;if(!e._subPause()){var o=e.pcmBuffer,s=o[0],c=o[1],d=s.length+c.length;if(0==d||d<f)e._playEnd();else{e._playLive();for(var l=0,p=1,h=t.realtime;h;){if(s.length<.3*a){h=!1;break}var _=3*a;s.length>_&&(s=s.subarray(s.length-_),o[0]=s),p=1.6,l=Math.min(i,Math.floor((s.length+c.length)/p));break}if(h||(l=Math.min(i,s.length+c.length)),l){r=n.createBuffer(1,l,a),e._subWrite(r,l,0,p),v(r.getChannelData(0),a);var m=n.createBufferSource();m.channelCount=1,m.buffer=r,m.connect(e._dest),t.play&&m.connect(n.destination),m.start(),e.bufferSource=m,e.audioBuffer=r,e._createBufferTime=Date.now()}}}},_subPause:function(){return this.isPause?(this.set.realtime&&(this.pcmBuffer=[[],[]]),1):0},_subWrite:function(e,t,r,a){for(var n=this.pcmBuffer,u=n[0],i=n[1],f=new Int16Array(t),o=0,s=0,c=0;s<t&&c<u.length;)f[s++]=u[o],c+=a,o=Math.round(c);if(o>=u.length){for(u=new Int16Array(0),o=c=0;s<t&&c<i.length;)f[s++]=i[o],c+=a,o=Math.round(c);i=o>=i.length?new Int16Array(0):i.subarray(o),n[1]=i}else u=u.subarray(o);n[0]=u;var d=e.getChannelData(0);for(o=0;o<t;o++,r++)d[r]=f[o]/32767;return this._Tc+=t,this._updateTime(),r}};var v=l.FadeInOut=function(e,t){for(var r=t/1e3*1,a=0;a<r;a++)e[a]*=a/r;var n=e.length;for(a=~~(n-r);a<n;a++)e[a]*=(n-a)/r},n=l.DecodeAudio=function(e,i,t){Recorder.Support()?Recorder.Ctx.decodeAudioData(e,function(e){for(var t=e.getChannelData(0),r=e.sampleRate,a=new Int16Array(t.length),n=0;n<t.length;n++){var u=Math.max(-1,Math.min(1,t[n]));u=u<0?32768*u:32767*u,a[n]=u}i&&i({sampleRate:r,duration:Math.round(t.length/r*1e3),data:a})},function(e){t&&t("音频解码失败:"+(e&&e.message||"-"))}):t&&t("浏览器不支持音频解码")};Recorder[p]=l}();
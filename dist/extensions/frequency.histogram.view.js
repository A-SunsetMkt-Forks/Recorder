/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/frequency.histogram.view.js
*/
!function(t){var e="object"==typeof window&&!!window.document,r=(e?window:Object).Recorder,a=r.i18n;!function(c,t,d,p){"use strict";var e=function(t){return new r(t)},w="FrequencyHistogramView",r=function(t){var e=this,r={scale:2,fps:20,lineCount:30,widthRatio:.6,spaceWidth:0,minHeight:0,position:-1,mirrorEnable:!1,stripeEnable:!0,stripeHeight:3,stripeMargin:6,fallDuration:1e3,stripeFallDuration:3500,linear:[0,"rgba(0,187,17,1)",.5,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],stripeLinear:null,shadowBlur:0,shadowColor:"#bbb",stripeShadowBlur:-1,stripeShadowColor:"",onDraw:function(t,e){}};for(var a in t)r[a]=t[a];e.set=t=r;var i="compatibleCanvas";if(t[i])var o=e.canvas=t[i];else{if(!p)throw new Error(d.G("NonBrowser-1",[w]));var n=t.elem;n&&("string"==typeof n?n=document.querySelector(n):n.length&&(n=n[0])),n&&(t.width=n.offsetWidth,t.height=n.offsetHeight);var l=e.elem=document.createElement("div");l.style.fontSize=0,l.innerHTML='<canvas style="width:100%;height:100%;"/>';var o=e.canvas=l.querySelector("canvas");n&&(n.innerHTML="",n.appendChild(l))}var s=t.scale,h=t.width*s,f=t.height*s;if(!h||!f)throw new Error(d.G("IllegalArgs-1",[w+" width=0 height=0"]));o.width=h,o.height=f;e.ctx=o.getContext("2d");if(!c.LibFFT)throw new Error(d.G("NeedImport-2",[w,"src/extensions/lib.fft.js"]));e.fft=c.LibFFT(1024),e.lastH=[],e.stripesH=[]};r.prototype=e.prototype={genLinear:function(t,e,r,a){for(var i=t.createLinearGradient(0,r,0,a),o=0;o<e.length;)i.addColorStop(e[o++],e[o++]);return i},input:function(t,e,r){var a=this;a.sampleRate=r,a.pcmData=t,a.pcmPos=0,a.inputTime=Date.now(),a.schedule()},schedule:function(){var t=this,e=t.set,r=Math.floor(1e3/e.fps);t.timer||(t.timer=setInterval(function(){t.schedule()},r));var a=Date.now(),i=t.drawTime||0;if(a-t.inputTime>1.3*e.stripeFallDuration)return clearInterval(t.timer),t.timer=0,t.lastH=[],t.stripesH=[],void t.draw(null,t.sampleRate);if(!(a-i<r)){t.drawTime=a;for(var o=t.fft.bufferSize,n=t.pcmData,l=t.pcmPos,s=new Int16Array(o),h=0;h<o&&l<n.length;h++,l++)s[h]=n[l];t.pcmPos=l;var f=t.fft.transform(s);t.draw(f,t.sampleRate)}},draw:function(t,e){var r=this,a=r.set,i=r.ctx,o=a.scale,n=a.width*o,l=a.height*o,s=a.lineCount,h=r.fft.bufferSize,f=a.position,c=Math.abs(a.position),d=1==f?0:l,p=l;c<1&&(d=p/=2,p=Math.floor(p*(1+c)),d=Math.floor(0<f?d*(1-c):d*(1+c)));for(var w=r.lastH,u=r.stripesH,v=Math.ceil(p/(a.fallDuration/(1e3/a.fps))),g=Math.ceil(p/(a.stripeFallDuration/(1e3/a.fps))),m=a.stripeMargin*o,M=1<<(Math.round(Math.log(h)/Math.log(2)+3)<<1),b=Math.log(M)/Math.log(10),L=20*Math.log(32767)/Math.log(10),y=h/2,H=Math.min(y,Math.floor(5e3*y/(e/2))),S=H==y,C=S?s:Math.round(.8*s),D=H/C,R=S?0:(y-H)/(s-C),T=0,B=0;B<s;B++){var E=Math.ceil(T);T+=B<C?D:R;var F=Math.min(Math.ceil(T),y),x=0;if(t)for(var I=E;I<F;I++)x=Math.max(x,Math.abs(t[I]));var G=M<x?Math.floor(17*(Math.log(x)/Math.log(10)-b)):0,j=p*Math.min(G/L,1);w[B]=(w[B]||0)-v,j<w[B]&&(j=w[B]),j<0&&(j=0),w[B]=j;var q=u[B]||0;if(j&&q<j+m)u[B]=j+m;else{var z=q-g;z<0&&(z=0),u[B]=z}}i.clearRect(0,0,n,l);var P=r.genLinear(i,a.linear,d,d-p),W=a.stripeLinear&&r.genLinear(i,a.stripeLinear,d,d-p)||P,A=r.genLinear(i,a.linear,d,d+p),N=a.stripeLinear&&r.genLinear(i,a.stripeLinear,d,d+p)||A;i.shadowBlur=a.shadowBlur*o,i.shadowColor=a.shadowColor;var O=a.mirrorEnable,V=O?2*s-1:s,$=a.widthRatio,k=a.spaceWidth*o;0!=k&&($=(n-k*(V+1))/n);for(var J=Math.max(1*o,Math.floor(n*$/V)),K=(n-V*J)/(V+1),Q=a.minHeight*o,U=K+J/2,X=O?n/2-U:0,B=0,Y=X;B<s;B++)Y+=K,_=Math.floor(Y),j=Math.max(w[B],Q),0!=d&&(tt=d-j,i.fillStyle=P,i.fillRect(_,tt,J,j)),d!=l&&(i.fillStyle=A,i.fillRect(_,d,J,j)),Y+=J;if(a.stripeEnable){var Z=a.stripeShadowBlur;i.shadowBlur=(-1==Z?a.shadowBlur:Z)*o,i.shadowColor=a.stripeShadowColor||a.shadowColor;for(var _,tt,et=a.stripeHeight*o,B=0,Y=X;B<s;B++)Y+=K,_=Math.floor(Y),j=u[B],0!=d&&((tt=d-j-et)<0&&(tt=0),i.fillStyle=W,i.fillRect(_,tt,J,et)),d!=l&&(l<(tt=d+j)+et&&(tt=l-et),i.fillStyle=N,i.fillRect(_,tt,J,et)),Y+=J}if(O){var rt=Math.floor(n/2);i.save(),i.scale(-1,1),i.drawImage(r.canvas,Math.ceil(n/2),0,rt,l,-rt,0,rt,l),i.restore()}t&&a.onDraw(t,e)}},c[w]=e}(r,0,a.$T,e)}();